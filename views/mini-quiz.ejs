<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/styles.css">
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      }
    };
  </script>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    .quiz-container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 2rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .quiz-header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #3b82f6;
    }
    
    .quiz-header h1 {
      color: #1e40af;
      margin-bottom: 0.5rem;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 1rem;
    }
    
    .progress-fill {
      height: 100%;
      background: #3b82f6;
      transition: width 0.3s ease;
    }
    
    .question-card {
      display: none;
      animation: fadeIn 0.3s;
    }
    
    .question-card.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .question-number {
      font-size: 0.875rem;
      color: #6b7280;
      margin-bottom: 0.5rem;
    }
    
    .question-text {
      font-size: 1.25rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 1.5rem;
      line-height: 1.6;
    }
    
    .options {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .option-btn {
      padding: 1rem;
      background: #f3f4f6;
      border: 2px solid #d1d5db;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
      font-size: 1rem;
      color: #374151;
    }
    
    .option-btn:hover {
      background: #e5e7eb;
      border-color: #9ca3af;
    }
    
    .option-btn.selected {
      background: #dbeafe;
      border-color: #3b82f6;
      color: #1e40af;
    }
    
    .option-btn.correct {
      background: #d1fae5;
      border-color: #10b981;
      color: #065f46;
    }
    
    .option-btn.incorrect {
      background: #fee2e2;
      border-color: #ef4444;
      color: #991b1b;
    }
    
    .option-btn:disabled {
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    .nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 2rem;
      gap: 1rem;
    }
    
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: #3b82f6;
      color: white;
    }
    
    .btn-primary:hover {
      background: #2563eb;
    }
    
    .btn-secondary {
      background: #6b7280;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #4b5563;
    }
    
    .btn:disabled {
      background: #d1d5db;
      cursor: not-allowed;
    }
    
    .results-container {
      display: none;
      text-align: center;
      padding: 2rem;
    }
    
    .results-container.active {
      display: block;
    }
    
    .score-display {
      font-size: 3rem;
      font-weight: bold;
      color: #3b82f6;
      margin: 2rem 0;
    }
    
    .score-message {
      font-size: 1.5rem;
      color: #1f2937;
      margin-bottom: 2rem;
    }
    
    .feedback {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 6px;
      font-weight: 500;
      display: none;
    }
    
    .feedback.show {
      display: block;
    }
    
    .feedback.correct {
      background: #d1fae5;
      color: #065f46;
    }
    
    .feedback.incorrect {
      background: #fee2e2;
      color: #991b1b;
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="quiz-container">
    <div class="quiz-header">
      <h1><%= title %></h1>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <p class="question-number" id="questionCounter">Question 1 of <%= questions.length %></p>
    </div>
    
    <div id="quizContent">
      <% questions.forEach((q, index) => { %>
        <div class="question-card" data-question-index="<%= index %>">
          <div class="question-text"><%= q.question %></div>
          <div class="options" data-correct="<%= q.correct %>">
            <% q.options.forEach((option, optIndex) => { %>
              <button class="option-btn" data-option-index="<%= optIndex %>">
                <%= option %>
              </button>
            <% }); %>
          </div>
          <div class="feedback" id="feedback-<%= index %>"></div>
        </div>
      <% }); %>
    </div>
    
    <div class="results-container" id="results">
      <h2 class="score-message">Quiz Completed!</h2>
      <div class="score-display" id="scoreDisplay">0/<%= questions.length %></div>
      <p id="scoreMessage"></p>
      <div class="nav-buttons">
        <button class="btn btn-primary" onclick="restartQuiz()">Restart Quiz</button>
        <a href="/physci" class="btn btn-secondary">Back to Physical Science</a>
      </div>
    </div>
    
    <div class="nav-buttons" id="navButtons">
      <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()" disabled>Next</button>
      <button class="btn btn-primary" id="submitBtn" onclick="submitQuiz()" style="display: none;" disabled>Submit Quiz</button>
    </div>
  </div>

  <script>
    let currentQuestion = 0;
    let userAnswers = [];
    let questionOrder = [];
    let quizData = <%- JSON.stringify(questions) %>;
    
    // Shuffle array function
    function shuffle(array) {
      const newArray = [...array];
      for (let i = newArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
      }
      return newArray;
    }
    
    // Initialize quiz with randomization
    function initQuiz() {
      // Create random question order
      questionOrder = shuffle([...Array(quizData.length).keys()]);
      
      // Randomize options for each question
      quizData.forEach((question, qIndex) => {
        const optionsWithIndex = question.options.map((opt, idx) => ({
          text: opt,
          originalIndex: idx
        }));
        const shuffledOptions = shuffle(optionsWithIndex);
        
        // Update correct answer index based on new order
        const correctOriginalIndex = question.correct;
        const newCorrectIndex = shuffledOptions.findIndex(
          opt => opt.originalIndex === correctOriginalIndex
        );
        
        // Store shuffled data
        question.shuffledOptions = shuffledOptions;
        question.newCorrectIndex = newCorrectIndex;
      });
      
      // Reorder DOM elements based on question order
      const quizContent = document.getElementById('quizContent');
      const questionCards = Array.from(document.querySelectorAll('.question-card'));
      
      questionOrder.forEach((originalIndex, newIndex) => {
        const card = questionCards[originalIndex];
        const optionsContainer = card.querySelector('.options');
        const question = quizData[originalIndex];
        
        // Update options in DOM
        const optionBtns = Array.from(optionsContainer.querySelectorAll('.option-btn'));
        question.shuffledOptions.forEach((opt, idx) => {
          optionBtns[idx].textContent = opt.text;
          optionBtns[idx].setAttribute('data-option-index', idx);
        });
        
        // Update correct answer in data attribute
        optionsContainer.setAttribute('data-correct', question.newCorrectIndex);
        
        quizContent.appendChild(card);
      });
      
      userAnswers = new Array(quizData.length).fill(null);
      showQuestion(0);
      updateProgress();
      
      // Trigger MathJax rendering
      if (window.MathJax) {
        MathJax.typesetPromise();
      }
    }
    
    function showQuestion(index) {
      const cards = document.querySelectorAll('.question-card');
      cards.forEach((card, i) => {
        card.classList.toggle('active', i === index);
      });
      
      currentQuestion = index;
      updateButtons();
      updateProgress();
      
      // Re-render math if needed
      if (window.MathJax) {
        MathJax.typesetPromise();
      }
    }
    
    function updateProgress() {
      const progress = ((currentQuestion + 1) / quizData.length) * 100;
      document.getElementById('progressFill').style.width = progress + '%';
      document.getElementById('questionCounter').textContent = 
        `Question ${currentQuestion + 1} of ${quizData.length}`;
    }
    
    function updateButtons() {
      const nextBtn = document.getElementById('nextBtn');
      const submitBtn = document.getElementById('submitBtn');
      
      // Disable next/submit if current question is not answered
      const isAnswered = userAnswers[currentQuestion] !== null;
      
      if (currentQuestion === quizData.length - 1) {
        nextBtn.style.display = 'none';
        submitBtn.style.display = 'block';
        submitBtn.disabled = !isAnswered;
      } else {
        nextBtn.style.display = 'block';
        submitBtn.style.display = 'none';
        nextBtn.disabled = !isAnswered;
      }
    }
    
    function nextQuestion() {
      if (currentQuestion < quizData.length - 1) {
        showQuestion(currentQuestion + 1);
      }
    }
    
    function submitQuiz() {
      // Count correct answers (userAnswers[i] >= 0 means correct, -1 means incorrect)
      let score = userAnswers.filter(answer => answer >= 0).length;
      
      // Show results
      document.getElementById('quizContent').style.display = 'none';
      document.getElementById('navButtons').style.display = 'none';
      document.getElementById('results').classList.add('active');
      document.getElementById('scoreDisplay').textContent = `${score}/${quizData.length}`;
      
      const percentage = (score / quizData.length) * 100;
      let message = '';
      if (percentage >= 90) {
        message = 'Excellent work! ðŸŽ‰';
      } else if (percentage >= 75) {
        message = 'Great job! ðŸ‘';
      } else if (percentage >= 60) {
        message = 'Good effort! ðŸ‘';
      } else {
        message = 'Keep studying! ðŸ“š';
      }
      document.getElementById('scoreMessage').textContent = message;
    }
    
    function restartQuiz() {
      location.reload();
    }
    
    // Event delegation for option buttons
    document.getElementById('quizContent').addEventListener('click', function(e) {
      if (e.target.classList.contains('option-btn') && !e.target.disabled) {
        const card = e.target.closest('.question-card');
        const optionsContainer = card.querySelector('.options');
        const correctIndex = parseInt(optionsContainer.getAttribute('data-correct'));
        const optionIndex = parseInt(e.target.getAttribute('data-option-index'));
        const options = card.querySelectorAll('.option-btn');
        const feedback = card.querySelector('.feedback');
        
        // Disable all options after selection
        options.forEach(btn => btn.disabled = true);
        
        // Show correct answer
        options[correctIndex].classList.add('correct');
        
        // Show if selected answer is correct or wrong
        if (optionIndex === correctIndex) {
          e.target.classList.add('selected');
          feedback.textContent = 'âœ“ Great job! That\'s correct!';
          feedback.classList.add('correct', 'show');
          userAnswers[currentQuestion] = optionIndex;
        } else {
          e.target.classList.add('incorrect');
          feedback.textContent = 'Not quite! The correct answer is shown in green above.';
          feedback.classList.add('incorrect', 'show');
          userAnswers[currentQuestion] = -1; // Mark as answered incorrectly
        }
        
        // Enable next/submit button after answer is selected
        updateButtons();
      }
    });
    
    // Initialize quiz on page load
    initQuiz();
  </script>
</body>
</html>
